{% extends "base.html" %}
{% block content %}

{% if session.get('rol') == 'admin' %}
<div class="d-flex justify-content-end mb-3">
    <a href="{{ url_for('gestion_usuarios') }}" class="btn btn-outline-secondary">
        游논 Gestionar Usuarios
    </a>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>游늵 Panel de Gesti칩n Pedag칩gica</h3>
    <a href="{{ url_for('nueva_visita') }}" class="btn btn-success">+ Nueva Visita</a>
</div>

<!-- Filtro por mes + Bot칩n din치mico -->
<div class="row mb-3">
    <div class="col-md-4">
        <label for="filtroMes" class="form-label">Filtrar por mes</label>
        <select id="filtroMes" class="form-select">
            <option value="" {% if not mes_filtro %}selected{% endif %}>Todos los meses</option>
            <option value="2025-10" {% if mes_filtro == '2025-10' %}selected{% endif %}>Octubre 2025</option>
            <option value="2025-11" {% if mes_filtro == '2025-11' %}selected{% endif %}>Noviembre 2025</option>
            <option value="2025-12" {% if mes_filtro == '2025-12' %}selected{% endif %}>Diciembre 2025</option>
        </select>
    </div>
    <div class="col-md-8 d-flex align-items-end">
        <a id="btnGenerarInforme" href="/generar_informe_mensual/todos" class="btn btn-primary w-100">
            游늯 Generar Informe Mensual ({{ 'Todos los meses' if not mes_filtro else mes_filtro }})
        </a>
    </div>
</div>

<!-- Resumen -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5>Total Visitas</h5>
                <h3>{{ total_visitas }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5>Este Mes</h5>
                <h3>{{ visitas_mes }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5>Meta Mensual</h5>
                <h3>30</h3>
                <small class="text-dark">({{ '%.0f' | format(porcentaje_meta) }}% alcanzado)</small>
            </div>
        </div>
    </div>
</div>

<!-- Gr치ficos -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Visitas por Nivel</div>
            <div class="card-body">
                <canvas id="graficoNivel"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Visitas por Tipo</div>
            <div class="card-body">
                <canvas id="graficoTipo"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-end mb-3">
    <a href="{{ url_for('exportar_excel') }}" class="btn btn-outline-primary">
        游닌 Exportar a Excel
    </a>
</div>

<!-- Tabla de visitas registradas -->
<h4>游늶 Visitas Registradas</h4>
<div class="table-responsive">
    <table id="tablaVisitas" class="table table-striped">
        <thead>
            <tr>
                <th>N춿 Informe</th>
                <th>Fecha</th>
                <th>Instituci칩n</th>
                <th>Nivel</th>
                <th>ID Especialista</th>
                <th>Tipo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% if visitas %}
                {% for v in visitas %}
                    <tr>
                        <td>{{ v['numero_informe'] }}</td>
                        <td>{{ v['fecha'] }}</td>
                        <td>{{ v['institucion'] }}</td>
                        <td>{{ v['nivel'] }}</td>
                        <td>{{ v['usuario_id'] }}</td>
                        <td>{{ v['tipo_visita'] }}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('generar_ppt', visita_id=v['id']) }}" class="btn btn-success">PPT</a>
                                <a href="{{ url_for('generar_pdf', visita_id=v['id']) }}" class="btn btn-danger">PDF</a>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted">No hay visitas registradas.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Chart.js + Filtro din치mico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Datos desde Flask
    const niveles = {{ niveles | tojson }};
    const tipos = {{ tipos | tojson }};
    const mesFiltro = "{{ mes_filtro }}";

    // Gr치fico por nivel
    new Chart(document.getElementById('graficoNivel'), {
        type: 'bar',
        data: {
            labels: Object.keys(niveles),
            datasets: [{
                label: 'N칰mero de Visitas',
                data: Object.values(niveles),
                backgroundColor: '#007bff'
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // Gr치fico por tipo
    new Chart(document.getElementById('graficoTipo'), {
        type: 'pie',
        data: {
            labels: Object.keys(tipos),
            datasets: [{
                data: Object.values(tipos),
                backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0']
            }]
        },
        options: { responsive: true }
    });

    // Filtro por mes + actualizaci칩n de bot칩n
    document.getElementById('filtroMes').addEventListener('change', function() {
        const mes = this.value;
        if (mes) {
            document.getElementById('btnGenerarInforme').href = `/generar_informe_mensual/${mes}`;
            document.getElementById('btnGenerarInforme').textContent = `游늯 Generar Informe Mensual (${mes})`;
        } else {
            document.getElementById('btnGenerarInforme').href = `/generar_informe_mensual/todos`;
            document.getElementById('btnGenerarInforme').textContent = `游늯 Generar Informe Mensual (Todos los meses)`;
        }
        window.location.href = `/dashboard?mes=${mes}`;
    });
</script>
{% endblock %}